<!DOCTYPE html>
<html>

<head>
    <title>Fetch Debug Test</title>
</head>

<body>
    <h1>Fetch Debug Test</h1>
    <button onclick="testFetch()">Test Login</button>
    <button onclick="testConfig()">Test Config</button>
    <button onclick="testSequence()">Test Sequence</button>
    <div id="result"></div>

    <script>
        async function testFetch() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testing login...';

            try {
                console.error('ðŸ”¥ DIRECT TEST: About to call fetch');
                console.error('ðŸ”¥ DIRECT TEST: Starting timestamp:', new Date().toISOString());

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                const response = await fetch('https://admin.mtool.ovh/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': 'https://admin.mtool.ovh'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    }),
                    credentials: 'same-origin', // Match backend CORS settings
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.error('ðŸ”¥ DIRECT TEST: Fetch succeeded:', response.status);
                console.error('ðŸ”¥ DIRECT TEST: Response timestamp:', new Date().toISOString());
                console.error('ðŸ”¥ DIRECT TEST: Response headers:', [...response.headers.entries()]);

                const data = await response.json();
                console.error('ðŸ”¥ DIRECT TEST: Data received:', data);
                resultDiv.innerHTML = `
                    <h3>Success!</h3>
                    <p>Status: ${response.status}</p>
                    <p>Response time: ${new Date().toISOString()}</p>
                    <p>Headers: ${JSON.stringify([...response.headers.entries()], null, 2)}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

            } catch (error) {
                console.error('ðŸ”¥ DIRECT TEST: Fetch failed:', error);
                console.error('ðŸ”¥ DIRECT TEST: Error timestamp:', new Date().toISOString());
                console.error('ðŸ”¥ DIRECT TEST: Error name:', error.name);
                console.error('ðŸ”¥ DIRECT TEST: Error message:', error.message);
                console.error('ðŸ”¥ DIRECT TEST: Error stack:', error.stack);
                console.error('ðŸ”¥ DIRECT TEST: Error constructor:', error.constructor.name);

                resultDiv.innerHTML = `
                    <h3>Error!</h3>
                    <p>Name: ${error.name}</p>
                    <p>Message: ${error.message}</p>
                    <p>Constructor: ${error.constructor.name}</p>
                    <p>Timestamp: ${new Date().toISOString()}</p>
                    <pre>${error.stack}</pre>
                `;
            }
        }

        async function testConfig() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testing config...';

            try {
                console.error('ðŸ”¥ CONFIG TEST: About to call fetch');

                const response = await fetch('https://admin.mtool.ovh/api/config', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.error('ðŸ”¥ CONFIG TEST: Fetch succeeded:', response.status);
                const data = await response.json();
                console.error('ðŸ”¥ CONFIG TEST: Data:', data);
                resultDiv.innerHTML = `Config Success: ${response.status}<br>Data: ${JSON.stringify(data, null, 2)}`;

            } catch (error) {
                console.error('ðŸ”¥ CONFIG TEST: Fetch failed:', error);
                resultDiv.innerHTML = `Config Error: ${error.message}<br>Name: ${error.name}`;
            }
        }

        async function testSequence() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testing sequence: config then login...';

            try {
                // First get config
                console.error('ðŸ”¥ SEQUENCE: Step 1 - Getting config');
                const configResponse = await window.fetch('https://admin.mtool.ovh/api/config');
                const config = await configResponse.json();
                console.error('ðŸ”¥ SEQUENCE: Config received:', config);

                // Then try login with window.fetch vs fetch
                console.error('ðŸ”¥ SEQUENCE: Step 2 - Trying login with window.fetch');
                const loginResponse1 = await window.fetch('https://admin.mtool.ovh/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                console.error('ðŸ”¥ SEQUENCE: Step 3 - Trying login with plain fetch');
                const loginResponse2 = await fetch('https://admin.mtool.ovh/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                const loginData1 = await loginResponse1.json();
                const loginData2 = await loginResponse2.json();
                console.error('ðŸ”¥ SEQUENCE: Both logins succeeded');
                resultDiv.innerHTML = `Sequence Success!<br>Config: ${JSON.stringify(config)}<br>Login1 (window.fetch): ${loginResponse1.status}<br>Login2 (fetch): ${loginResponse2.status}`;

            } catch (error) {
                console.error('ðŸ”¥ SEQUENCE: Failed:', error);
                resultDiv.innerHTML = `Sequence Error: ${error.message}`;
            }
        }
    </script>
</body>

</html>